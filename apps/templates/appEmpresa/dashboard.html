{% extends 'includes/side-nav.html' %}

{% load static %}

{% load my_filters %}

{% block title %}Dashboard{% endblock %}


{% block content2 %}
<div class="container-fluid py-4">
  <div class="row">
    <!--  4 quadrados info  -->
    <h2 class="mb-0">Painel de Controle</h2>
    <p class="mb-4 ms-1">Aqui você encontra as principais informações do seu negócio.</p>

      <div class="col-lg-7">
        <div class="row">
          <div class="col-lg-6 col-sm-6">
            <div class="card  mb-4">
              <div class="card-body p-3">
                <div class="row">
                  <div class="col-8">
                    <div class="numbers">
                      <p class="text-sm mb-0 text-capitalize font-weight-bold">Faturamento Hoje</p>
                      <h5 class="font-weight-bolder mb-0">
                        R$ {{ vendas_hoje|floatformat:2 }}
                        <span class="{% if variacao_percentual >= 0 %}text-success{% else %}text-danger{% endif %} text-sm font-weight-bolder">
                          {% if variacao_percentual >= 0 %}+{% endif %}{{ variacao_percentual|floatformat:1 }}%
                        </span>
                      </h5>
                    </div>
                  </div>
                  <div class="col-4 d-flex justify-content-end">
                    <div class="icon icon-shape bg-danger shadow-danger text-center border-radius-md" data-bs-toggle="tooltip" data-bs-placement="left" data-bs-original-title="Veja seu faturamento no dia de hoje (Pedidos Entregues). Percentual é relacionado ao dia de ontem!">
                      <i class="ni ni-money-coins text-lg opacity-10" aria-hidden="true"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="card ">
              <div class="card-body p-3">
                <div class="row">
                  <div class="col-8">
                    <div class="numbers">
                      <p class="text-sm mb-0 text-capitalize font-weight-bold">Lucro Mês</p>
                      <h5 class="font-weight-bolder mb-0">
                        R$ {{ lucro_mes_atual }}
                        <span class="{% if variacao_percentual_lucro >= 0 %}text-success{% else %}text-danger{% endif %} text-sm font-weight-bolder">
                          {% if variacao_percentual_lucro >= 0 %}+{% endif %}{{ variacao_percentual_lucro|floatformat:1 }}%
                        </span>
                      </h5>
                    </div>
                  </div>
                  <div class="col-4 d-flex justify-content-end">
                    <div class="icon icon-shape bg-danger shadow-danger text-center border-radius-md" data-bs-toggle="tooltip" data-bs-placement="left" data-bs-original-title="Veja seu lucro, é calculado com Pedidos Entregues contando o custo de produção que está na aba receitas. Percentual é relacionado ao mês passado!">
                      <i class="ni ni-world text-lg opacity-10" aria-hidden="true"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6 col-sm-6 mt-sm-0 mt-4">
            <div class="card  mb-4">
              <div class="card-body p-3">
                <div class="row">
                  <div class="col-8">
                    <div class="numbers">
                      <p class="text-sm mb-0 text-capitalize font-weight-bold">Clientes Hoje</p>
                      <h5 class="font-weight-bolder mb-0">
                        {{ clientes_novos }}
                        <span class="{% if variacao_percentual_clientes >= 0 %}text-success{% else %}text-danger{% endif %} text-sm font-weight-bolder">
                          {% if variacao_percentual_clientes >= 0 %}+{% endif %}{{ variacao_percentual_clientes|floatformat:1 }}%
                        </span>
                      </h5>
                    </div>
                  </div>
                  <div class="col-4 d-flex justify-content-end">
                    <div class="icon icon-shape bg-danger shadow-danger text-center border-radius-md" data-bs-toggle="tooltip" data-bs-placement="left" data-bs-original-title="Veja quantos clientes você atendeu no dia de hoje (Pedidos Entregues). Percentual é relacionado ao dia de ontem!">
                      <i class="ni ni-paper-diploma text-lg opacity-10" aria-hidden="true"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="card ">
              <div class="card-body p-3">
                <div class="row">
                  <div class="col-8">
                    <div class="numbers">
                      <p class="text-sm mb-0 text-capitalize font-weight-bold">Vendas Mês</p>
                      <h5 class="font-weight-bolder mb-0">
                        R$ {{ vendas_mes_atual|floatformat:2 }}
                        <span class="{% if variacao_percentual_vendas_mes >= 0 %}text-success{% else %}text-danger{% endif %} text-sm font-weight-bolder">
                          {% if variacao_percentual_vendas_mes >= 0 %}+{% endif %}{{ variacao_percentual_vendas_mes|floatformat:1 }}%
                        </span>
                      </h5>
                    </div>
                  </div>
                  <div class="col-4 d-flex justify-content-end">
                    <div class="icon icon-shape bg-danger shadow-danger text-center border-radius-md" data-bs-toggle="tooltip" data-bs-placement="left" data-bs-original-title="Veja seu total de faturamento com pedidos neste mês (Pedidos Entregues). Percentual é relacionado ao mês passado!">
                      <i class="ni ni-cart text-lg opacity-10" aria-hidden="true"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>






        <div class="mt-4">
          <div class="card h-100">
            <div class="card-header pb-0 p-3 d-flex justify-content-between">
              <h6 class="mb-0">Avaliações</h6>
            </div>
            <div class="card-body pb-0 p-3">
              <ul class="list-group">
                <li class="list-group-item border-0 d-flex align-items-center px-0 mb-0">
                  <div class="w-100">
                    <div class="d-flex mb-2">
                      <span class="me-2 text-sm font-weight-bold text-dark">Positivas</span>
                      <span class="ms-auto text-sm font-weight-bold">{{ avaliacoes_positivas|floatformat:0 }}%</span>
                    </div>
                    <div>
                      <div class="progress progress-md">
                        <div class="progress-bar bg-danger" role="progressbar" 
                             style="width: {{ avaliacoes_positivas|floatformat:0 }}%" 
                             aria-valuenow="{{ avaliacoes_positivas|floatformat:0 }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100"></div>
                      </div>
                    </div>
                  </div>
                </li>
                <li class="list-group-item border-0 d-flex align-items-center px-0 mb-2">
                  <div class="w-100">
                    <div class="d-flex mb-2">
                      <span class="me-2 text-sm font-weight-bold text-dark">Neutras</span>
                      <span class="ms-auto text-sm font-weight-bold">{{ avaliacoes_neutras|floatformat:0 }}%</span>
                    </div>
                    <div>
                      <div class="progress progress-md">
                        <div class="progress-bar bg-danger" role="progressbar" 
                             style="width: {{ avaliacoes_neutras|floatformat:0 }}%" 
                             aria-valuenow="{{ avaliacoes_neutras|floatformat:0 }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100"></div>
                      </div>
                    </div>
                  </div>
                </li>
                <li class="list-group-item border-0 d-flex align-items-center px-0 mb-2">
                  <div class="w-100">
                    <div class="d-flex mb-2">
                      <span class="me-2 text-sm font-weight-bold text-dark">Negativas</span>
                      <span class="ms-auto text-sm font-weight-bold">{{ avaliacoes_negativas|floatformat:0 }}%</span>
                    </div>
                    <div>
                      <div class="progress progress-md">
                        <div class="progress-bar bg-danger w-{{ avaliacoes_negativas|floatformat:0 }}" role="progressbar" 
                             aria-valuenow="{{ avaliacoes_negativas|floatformat:0 }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100"></div>
                      </div>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
            <div class="card-footer pt-0 p-3 d-flex align-items-center">
              <div class="w-60">
                <p class="text-sm">
                  Boas avaliações mantêm sua pizzaria em <b>destaque</b>. Continue melhorando sempre!
                </p>
              </div>
              <div class="w-40 text-end">
                <a class="btn btn-dark mb-0 text-end" href="{% url 'avaliacoes' cnpj=empresa.cnpj|remove_mask %}">Ver todas</a>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-5 col-sm-6 mt-lg-0 mt-4">
        <div class="card">
          <div class="card-body p-3 position-relative overflow-hidden" style="min-height: 515px;">
            <div class="row">
              <div class="col-10">
                <div class="numbers">
                  <h3 class="text-dark font-weight-bold mb-0">Visão Geral dos Pedidos</h3>
                  <p class="mb-0 mb-4">Acompanhe o alcance do seu negócio</p>
                  <h5 class="font-weight-bolder mb-0">
                    R$ {{ vendas_total|floatformat:2 }}
                  </h5>
                  <p class="mb-2">Vendas Total</p>
                  <h5 class="font-weight-bolder mb-0">
                    {{ clientes_atendidos }}
                  </h5>
                  <p class="mb-0">Clientes Total</p>
                </div>
              </div>
              <div class="col-2 text-end">
                <div class="icon icon-shape bg-danger shadow-danger text-center border-radius-md" data-bs-toggle="tooltip" data-bs-placement="left" data-bs-original-title="Veja seu faturamento total e quanto clientes diferentes já foram atendidos usando PizzazzZ (Pedidos Entregues).">
                  <i class="ni ni-square-pin text-lg opacity-10" aria-hidden="true"></i>
                </div>
              </div>
            </div>
            <div id="globe" class="position-absolute end-0 bottom-n2 mt-sm-3 peekaboo">
              <canvas width="570" height="608" class="w-lg-100 h-lg-100 w-75 h-75 me-lg-0 me-n8 mt-lg-5"></canvas>
            </div>
          </div>
        </div>
      </div>
    <!--  FIM 4 quadrados info  -->
  </div>

  <div class="row mt-4">
    <!--  CARD PUBLI  -->
    <div class="col-lg-7 mb-lg-0 mb-4">
      <div class="card" style="min-height: 240px;">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-lg-6">
              <div class="d-flex flex-column h-100">
                <p class="mb-1 pt-2 text-bold">Construido para pizzarias</p>
                <h5 class="font-weight-bolder">PizzazzZ</h5>
                <p class="mb-5">De controle de estoque, vendas, delivery, você encontrará tudo aqui.</p>
                <a class="text-body text-sm font-weight-bold mb-0 icon-move-right mt-auto" href="javascript:;">
                  Ler Mais
                  <i class="fas fa-arrow-right text-sm ms-1" aria-hidden="true"></i>
                </a>
              </div>
            </div>
            <div class="col-lg-5 ms-auto text-center mt-5 mt-lg-0">
              <div class="bg-danger border-radius-lg h-100">
                <div class="position-relative d-flex align-items-center justify-content-center h-100">
                  <img class="w-100 position-relative z-index-2 pt-4"
                    src="{{ASSETS_ROOT}}/img/illustrations/rocket-white.png" alt="rocket">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--  FIM CARD PUBLI  -->

    <!--  CARD TRABALHE  -->
    <div class="col-lg-5">
      <div class="card h-100 p-3">
        <div class="overflow-hidden position-relative border-radius-lg bg-cover h-100"
          style="background-image: url('/static/assets/img/ivancik.jpg');">
          <span class="mask bg-gradient-dark"></span>
          <div class="card-body position-relative z-index-1 d-flex flex-column h-100 p-3">
            <h5 class="text-white font-weight-bolder mb-4 pt-2">Gerencie com a PizzazzZ</h5>
            <p class="text-white">A criação de riqueza é um jogo de soma positiva recente do ponto de vista
              evolutivo. Trata-se de quem aproveita a oportunidade primeiro.</p>
            <a class="text-white text-sm font-weight-bold mb-0 icon-move-right mt-auto" href="javascript:;">
              Ler Mais
              <i class="fas fa-arrow-right text-sm ms-1" aria-hidden="true"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
    <!--  FIM CARD TRABALHE  -->
  </div>
  <div class="row mt-4">
    <!--  CHART USUARIOS  -->
    <!-- Substitua o conteúdo do primeiro card -->
<div class="col-lg-5 mb-lg-0 mb-4">
  <div class="card z-index-2" style="min-height: 420px;">
    <div class="card-body p-2">
      <div class="bg-dark border-radius-md py-3 pe-1 mb-3">
        <div class="chart">
          <canvas id="chart-bars" class="chart-canvas"></canvas>
        </div>
      </div>
      <h6 class="ms-2 mt-4 mb-0">Visão Geral</h6>
      <p class="text-sm ms-2 mb-4">Desempenho atual da pizzaria</p>
      <div class="container border-radius-lg ms-2">
        <div class="row">
          <div class="col-3 py-3 ps-0">
            <div class="d-flex mb-2">
              <div class="icon icon-shape icon-xxs shadow-danger border-radius-sm bg-danger text-center me-2 d-flex align-items-center justify-content-center">
                <i class="fas fa-shopping-cart"></i>
              </div>
              <p class="text-xs mt-1 mb-0 font-weight-bold">Pedidos</p>
            </div>
            <h4 class="font-weight-bolder">{{ estatisticas.pedidos_total }}</h4>
            <div class="progress w-75">
              <div class="progress-bar bg-dark w-60" role="progressbar"></div>
            </div>
          </div>
          <div class="col-3 py-3 ps-0">
            <div class="d-flex mb-2">
              <div class="icon icon-shape icon-xxs shadow-info border-radius-sm bg-info text-center me-2 d-flex align-items-center justify-content-center">
                <i class="fas fa-users"></i>
              </div>
              <p class="text-xs mt-1 mb-0 font-weight-bold">Clientes</p>
            </div>
            <h4 class="font-weight-bolder">{{ estatisticas.clientes_ativos }}</h4>
            <div class="progress w-75">
              <div class="progress-bar bg-dark w-90" role="progressbar"></div>
            </div>
          </div>
          <div class="col-3 py-3 ps-0">
            <div class="d-flex mb-2">
              <div class="icon icon-shape icon-xxs shadow-warning border-radius-sm bg-warning text-center me-2 d-flex align-items-center justify-content-center">
                <i class="fas fa-star"></i>
              </div>
              <p class="text-xs mt-1 mb-0 font-weight-bold">Avaliação</p>
            </div>
            <h4 class="font-weight-bolder">{{ estatisticas.avaliacao_media }}</h4>
            <div class="progress w-75">
              <div class="progress-bar bg-dark w-30" role="progressbar"></div>
            </div>
          </div>
          <div class="col-3 py-3 ps-0">
            <div class="d-flex mb-2">
              <div class="icon icon-shape icon-xxs shadow-primary border-radius-sm bg-primary text-center me-2 d-flex align-items-center justify-content-center">
                <i class="fas fa-pizza-slice"></i>
              </div>
              <p class="text-xs mt-1 mb-0 font-weight-bold">Cardápio</p>
            </div>
            <h4 class="font-weight-bolder">{{ estatisticas.itens_ativos }}</h4>
            <div class="progress w-75">
              <div class="progress-bar bg-dark w-50" role="progressbar"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
    <!--  FIM CHART USUARIOS  -->

    <!--  CHART RESUMO VENDAS  -->
    <div class="col-lg-7">
      <div class="card z-index-2">
        <div class="card-header pb-0">
          <div class="d-flex justify-content-between">
            <div>
              <h6>Resumo vendas</h6>
              <p class="text-sm">
                <i class="fa fa-arrow-{% if variacao_percentual_vendas >= 0 %}up text-success{% else %}down text-danger{% endif %}"></i>
                <span class="font-weight-bold">{% if variacao_percentual_vendas >= 0 %}+{% endif %}{{ variacao_percentual_vendas|floatformat:0 }}% </span>
                comparado com {% now "Y" as current_year %}{{ current_year|add:"-1" }}
              </p>
            </div>
            <button type="button" class="btn btn-icon-only btn-rounded btn-outline-secondary mb-0 ms-2 btn-sm d-flex align-items-center justify-content-center" data-bs-toggle="tooltip" data-bs-placement="left" data-bs-original-title="Veja suas vendas por mês">
              <i class="material-symbols-rounded text-sm">priority_high</i>
            </button>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="chart">
            <canvas id="chart-line" class="chart-canvas" height="600" width="1087"
              style="display: block; box-sizing: border-box; height: 300px; width: 543px;"></canvas>
          </div>
        </div>
      </div>
    </div>
    <!--  FIM CHART RESUMO VENDAS  -->

  </div>
  {% include 'includes/footer-emp.html' %}
</div>
<script src="{{ ASSETS_ROOT }}/js/plugins/threejs.js"></script>
<script src="{{ ASSETS_ROOT }}/js/plugins/orbit-controls.js"></script>
<script src="{{ ASSETS_ROOT }}/js/plugins/chartjs.min.js"></script>

<script>
  // Gráfico de barras - Pedidos por dia da semana
var ctx = document.getElementById("chart-bars").getContext("2d");
new Chart(ctx, {
  type: "bar",
  data: {
    labels: ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"],
    datasets: [{
      label: "Pedidos",
      tension: 0.4,
      borderWidth: 0,
      borderRadius: 4,
      borderSkipped: false,
      backgroundColor: "#fff",
      data: {{ pedidos_por_dia|safe }},
      maxBarThickness: 6
    }],
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        display: false,
      }
    },
    scales: {
      y: {
        grid: {
          drawBorder: false,
          display: false,
          drawOnChartArea: false,
          drawTicks: false,
        },
        ticks: {
          color: "#fff"
        },
      },
      x: {
        grid: {
          drawBorder: false,
          display: false,
          drawOnChartArea: false,
          drawTicks: false
        },
        ticks: {
          color: "#fff"
        },
      },
    },
  },
});

// Gráfico de linha - Vendas mensais
var ctx2 = document.getElementById("chart-line").getContext("2d");
new Chart(ctx2, {
  type: "line",
  data: {
    labels: {{ meses|safe }},
    datasets: [{
      label: "Vendas",
      tension: 0.4,
      borderWidth: 3,
      pointRadius: 2,
      borderColor: "#cb0c9f",
      backgroundColor: "rgba(203,12,159,0.2)",
      fill: true,
      data: {{ vendas_mensais|safe }},
    }],
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        display: false,
      }
    },
    scales: {
      y: {
        grid: {
          borderDash: [5, 5]
        }
      }
    },
  },
});


  (function() {
    const container = document.getElementById("globe");
    const canvas = container.getElementsByTagName("canvas")[0];

    const globeRadius = 100;
    const globeWidth = 4098 / 2;
    const globeHeight = 1968 / 2;

    function convertFlatCoordsToSphereCoords(x, y) {
      let latitude = ((x - globeWidth) / globeWidth) * -180;
      let longitude = ((y - globeHeight) / globeHeight) * -90;
      latitude = (latitude * Math.PI) / 180;
      longitude = (longitude * Math.PI) / 180;
      const radius = Math.cos(longitude) * globeRadius;

      return {
        x: Math.cos(latitude) * radius,
        y: Math.sin(longitude) * globeRadius,
        z: Math.sin(latitude) * radius
      };
    }

    function makeMagic(points) {
      const {
        width,
        height
      } = container.getBoundingClientRect();

      // 1. Setup scene
      const scene = new THREE.Scene();
      // 2. Setup camera
      const camera = new THREE.PerspectiveCamera(45, width / height);
      // 3. Setup renderer
      const renderer = new THREE.WebGLRenderer({
        canvas,
        antialias: true
      });
      renderer.setSize(width, height);
      // 4. Add points to canvas
      // - Single geometry to contain all points.
      const mergedGeometry = new THREE.Geometry();
      // - Material that the dots will be made of.
      const pointGeometry = new THREE.SphereGeometry(0.5, 1, 1);
      const pointMaterial = new THREE.MeshBasicMaterial({
        color: "#a1a1aa",
      });

      for (let point of points) {
        const {
          x,
          y,
          z
        } = convertFlatCoordsToSphereCoords(
          point.x,
          point.y,
          width,
          height
        );

        if (x && y && z) {
          pointGeometry.translate(x, y, z);
          mergedGeometry.merge(pointGeometry);
          pointGeometry.translate(-x, -y, -z);
        }
      }

      const globeShape = new THREE.Mesh(mergedGeometry, pointMaterial);
      scene.add(globeShape);

      container.classList.add("peekaboo");

      // Setup orbital controls
      camera.orbitControls = new THREE.OrbitControls(camera, canvas);
      camera.orbitControls.enableKeys = false;
      camera.orbitControls.enablePan = false;
      camera.orbitControls.enableZoom = false;
      camera.orbitControls.enableDamping = false;
      camera.orbitControls.enableRotate = true;
      camera.orbitControls.autoRotate = true;
      camera.position.z = -265;

      function animate() {
        // orbitControls.autoRotate is enabled so orbitControls.update
        // must be called inside animation loop.
        camera.orbitControls.update();
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      }
      animate();
    }

    function hasWebGL() {
      const gl =
        canvas.getContext("webgl") || canvas.getContext("experimental-webgl");
      if (gl && gl instanceof WebGLRenderingContext) {
        return true;
      } else {
        return false;
      }
    }

    function init() {
      if (hasWebGL()) {
        window
        window.fetch("{% static 'assets/js/points.json' %}")
          .then(response => response.json())
          .then(data => {
            makeMagic(data.points);
          });
      }
    }
    init();
  })();
</script>
 
{% endblock %}